{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="window.goBack()" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">Отклик на задачу</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <div x-data="respondToTask()" class="space-y-6">
            <!-- Task Details -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Детали задачи</h2>
                
                <!-- Loading State -->
                <div x-show="loading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                    <p class="text-gray-500">Загрузка задачи...</p>
                </div>

                <!-- Task Info -->
                <div x-show="!loading && task" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full" x-text="task ? getCategoryLabel(task.service_category) : 'Неизвестно'"></span>
                        <span class="text-lg font-bold text-gray-800" x-text="task && task.price ? task.price + ' ₽' : 'По договоренности'"></span>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800" x-text="task ? task.description : 'Описание не указано'"></h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt w-4 text-green-500 mr-3"></i>
                            <span x-text="task ? task.address : 'Адрес не указан'"></span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-calendar w-4 text-blue-500 mr-3"></i>
                            <span x-text="task ? formatDate(task.date) : 'Дата не указана'"></span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-comments w-4 text-purple-500 mr-3"></i>
                            <span x-text="task ? (task.responses_count || 0) + ' откликов' : '0 откликов'"></span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock w-4 text-indigo-500 mr-3"></i>
                            <span x-text="task ? formatDate(task.created_at) : 'Неизвестно'"></span>
                        </div>
                    </div>

                    <!-- Task Photos -->
                    <div x-show="task && task.photos && task.photos.length > 0" class="space-y-3">
                        <h4 class="font-medium text-gray-700">Фотографии:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <template x-for="(photo, index) in (task && task.photos ? task.photos : [])" :key="index">
                                <img :src="photo" :alt="'Фото ' + (index + 1)" class="w-full h-32 object-cover rounded-lg">
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div x-show="!loading && !task" class="text-center py-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-red-100 to-red-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-500 mb-2">Задача не найдена</h3>
                    <p class="text-gray-400">Попробуйте вернуться назад</p>
                </div>
            </div>

            <!-- Response Form -->
            <div x-show="!loading && task && !isOwnTask()" class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Ваше предложение</h2>
                
                <form @submit.prevent="submitResponse" class="space-y-6">
                    <!-- Price Offer -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Предлагаемая цена (₽)
                        </label>
                        <div class="relative">
                            <input
                                x-model="responseData.offer_price"
                                type="number"
                                min="0"
                                step="0.01"
                                required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300"
                                placeholder="Введите вашу цену"
                            >
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">₽</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Укажите стоимость за выполнение работы</p>
                    </div>

                    <!-- Message -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Сообщение заказчику
                        </label>
                        <textarea
                            x-model="responseData.message"
                            rows="4"
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 resize-none"
                            placeholder="Расскажите о вашем опыте, почему стоит выбрать именно вас..."
                        ></textarea>
                        <p class="text-sm text-gray-500 mt-1">Необязательно, но поможет заказчику сделать выбор</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex space-x-4">
                        <button
                            type="submit"
                            :disabled="submitting"
                            class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-6 rounded-xl font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        >
                            <span x-show="!submitting">
                                <i class="fas fa-paper-plane mr-2"></i>Отправить отклик
                            </span>
                            <span x-show="submitting">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Отправка...
                            </span>
                        </button>
                        
                        <button
                            type="button"
                            onclick="window.goBack()"
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all duration-300"
                        >
                            Отмена
                        </button>
                    </div>
                </form>
            </div>

            <!-- Error Message for Own Task -->
            <div x-show="!loading && task && isOwnTask()" class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-red-800 mb-2">Нельзя откликнуться на свою задачу</h3>
                <p class="text-red-600 mb-4">Это ваша собственная задача. Вы можете посмотреть отклики других пользователей.</p>
                <button @click="window.location.href=`/task/${getTaskIdFromUrl()}`" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Перейти к задаче
                </button>
            </div>
            
            <!-- Success Message -->
            <div x-show="success" class="bg-green-50 border border-green-200 rounded-2xl p-6 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-2xl text-green-600"></i>
                </div>
                <h3 class="text-lg font-medium text-green-800 mb-2">Отклик отправлен!</h3>
                <p class="text-green-600 mb-4">Заказчик получит уведомление о вашем предложении</p>
                <button @click="window.location.href='/my-responses'" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    Перейти к откликам
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function respondToTask() {
    return {
        loading: true,
        submitting: false,
        success: false,
        task: null,
        currentUser: null,
        responseData: {
            offer_price: '',
            message: ''
        },

        async init() {
            await this.loadCurrentUser();
            await this.loadTask();
        },
        
        async loadCurrentUser() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                // Декодируем токен для получения информации о пользователе
                const payload = JSON.parse(atob(token.split('.')[1]));
                this.currentUser = { phone: payload.sub };
                console.log('Current user:', this.currentUser);
            } catch (error) {
                console.error('Error loading current user:', error);
                window.location.href = '/login';
            }
        },
        
        isOwnTask() {
            return this.task && this.currentUser && 
                   this.task.customer_phone === this.currentUser.phone;
        },

        async loadTask() {
            try {
                const taskId = this.getTaskIdFromUrl();
                if (!taskId) {
                    this.loading = false;
                    return;
                }

                const token = localStorage.getItem('auth_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/v1/tasks/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const taskData = await response.json();
                    console.log('Task data received:', taskData);
                    
                    // Убеждаемся, что photos всегда является массивом
                    if (!taskData.photos || !Array.isArray(taskData.photos)) {
                        taskData.photos = [];
                    }
                    
                    this.task = taskData;
                    console.log('Task loaded with safe photos:', this.task);
                    
                    // Проверяем, не пытается ли пользователь откликнуться на свою задачу
                    if (this.isOwnTask()) {
                        alert('Вы не можете откликнуться на свою собственную задачу');
                        window.location.href = `/task/${this.getTaskIdFromUrl()}`;
                        return;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error loading task:', response.status, errorText);
                    // Попробуем без авторизации (для совместимости)
                    const fallbackResponse = await fetch(`/api/v1/tasks/tasks/${taskId}`);
                    if (fallbackResponse.ok) {
                        const taskData = await fallbackResponse.json();
                        console.log('Task data received via fallback:', taskData);
                        
                        // Убеждаемся, что photos всегда является массивом
                        if (!taskData.photos || !Array.isArray(taskData.photos)) {
                            taskData.photos = [];
                        }
                        
                        this.task = taskData;
                        console.log('Task loaded via fallback with safe photos:', this.task);
                        
                        // Проверяем, не пытается ли пользователь откликнуться на свою задачу
                        if (this.isOwnTask()) {
                            alert('Вы не можете откликнуться на свою собственную задачу');
                            window.location.href = `/task/${this.getTaskIdFromUrl()}`;
                            return;
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                this.loading = false;
            }
        },

        getTaskIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || this.getTaskIdFromPath();
        },

        getTaskIdFromPath() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        },

        async submitResponse() {
            try {
                this.submitting = true;
                const taskId = this.getTaskIdFromUrl();
                const token = localStorage.getItem('auth_token');

                if (!token || !taskId) {
                    throw new Error('Не авторизован или задача не найдена');
                }

                const response = await fetch(`/api/v1/tasks/tasks/${taskId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        offer_price: parseFloat(this.responseData.offer_price),
                        message: this.responseData.message || null
                    })
                });

                if (response.ok) {
                    this.success = true;
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + (error.detail || 'Не удалось отправить отклик'));
                }
            } catch (error) {
                console.error('Error submitting response:', error);
                alert('Ошибка: ' + error.message);
            } finally {
                this.submitting = false;
            }
        },

        getCategoryLabel(category) {
            const labels = {
                'movers': 'Грузчики',
                'computer_help': 'Компьютеры',
                'beauty_health': 'Красота',
                'handyman': 'Мастер',
                'household_help': 'Хозяйство',
                'laborers': 'Разнорабочие',
                'appliance_repair': 'Техника',
                'construction': 'Строительство',
                'tutoring': 'Обучение',
                'plumbing': 'Сантехника',
                'furniture': 'Мебель',
                'cleaning': 'Уборка',
                'electrical': 'Электрика',
                'legal': 'Юридические',
                'other': 'Другое'
            };
            return labels[category] || category;
        },
        
        formatDate(dateString) {
            if (!dateString) return 'Не указано';
            try {
                // Пробуем разные форматы даты
                let date;
                if (dateString.includes('-')) {
                    // ISO формат: 2025-09-02
                    date = new Date(dateString);
                } else if (dateString.includes('.')) {
                    // Русский формат: 02.09.2025
                    const parts = dateString.split('.');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else {
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    return dateString; // Возвращаем как есть, если не удалось распарсить
                }
                
                return date.toLocaleDateString('ru-RU');
            } catch (error) {
                console.error('Error formatting date:', dateString, error);
                return dateString;
            }
        }
    }
}
</script>
{% endblock %}
