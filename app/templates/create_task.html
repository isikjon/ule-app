{% extends "base.html" %}

{% block content %}
<div x-data="createTask()" class="glass-card rounded-3xl p-8 shadow-2xl animate-bounce-in">
    <!-- Header -->
    <div class="text-center mb-8">
        <div class="logo-container">
            <img src="https://wazir.kg/static/ule.jpg" alt="ULE Logo" class="logo">
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Создать задачу</h1>
        <p class="text-gray-600">Опишите, что нужно сделать</p>
    </div>

    <!-- Task Creation Form -->
    <form @submit.prevent="createTask()" class="space-y-6">
        <!-- Service Selection -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Услуга</label>
            <div class="relative">
                <select x-model="task.serviceCategory" class="input-focus w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-800 focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200 appearance-none pr-10" required>
                    <option value="">Выберите услугу</option>
                    <option value="movers">Грузчики, грузоперевозки</option>
                    <option value="computer_help">Компьютерная помощь</option>
                    <option value="beauty_health">Красота, здоровье</option>
                    <option value="handyman">Мастер на час</option>
                    <option value="household_help">Помощь в хозяйстве</option>
                    <option value="laborers">Разнорабочие</option>
                    <option value="appliance_repair">Ремонт бытовой техники</option>
                    <option value="construction">Ремонт и строительство</option>
                    <option value="tutoring">Репетиторы, обучение</option>
                    <option value="plumbing">Сантехника</option>
                    <option value="furniture">Сборка и ремонт мебели</option>
                    <option value="cleaning">Уборка, клининг</option>
                    <option value="electrical">Электрика</option>
                    <option value="legal">Юридическая помощь</option>
                    <option value="other">Другое</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Описание</label>
            <textarea
                x-model="task.description"
                rows="4"
                class="input-focus w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200 resize-none"
                placeholder="Опишите работу подробно..."
                required
                minlength="10"
            ></textarea>
        </div>

        <!-- Address -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Адрес</label>
            <input
                x-model="task.address"
                type="text"
                class="input-focus w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200"
                placeholder="Введите адрес"
                required
            >
        </div>

        <!-- Date -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Дата</label>
            <input
                x-model="task.date"
                type="date"
                class="input-focus w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-800 focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200"
                required
            >
        </div>

        <!-- Photos -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Фото</label>
            <div class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors">
                <div class="space-y-4">
                    <i class="fas fa-plus text-4xl text-blue-400"></i>
                    <div>
                        <p class="text-gray-600">Нажмите для загрузки фото</p>
                        <p class="text-sm text-gray-500">или перетащите файлы сюда</p>
                    </div>
                    <input
                        type="file"
                        multiple
                        accept="image/*"
                        @change="handlePhotoUpload($event)"
                        class="hidden"
                        id="photo-upload"
                    >
                    <button type="button" @click="$refs.photoUpload.click()" class="btn-gradient px-6 py-2 rounded-lg text-white font-medium">
                        Выбрать фото
                    </button>
                </div>
            </div>
            
            <!-- Photo Preview -->
            <div x-show="task.photos.length > 0" class="grid grid-cols-3 gap-4 mt-4">
                <template x-for="(photo, index) in task.photos" :key="index">
                    <div class="relative">
                        <img :src="photo" class="w-full h-24 object-cover rounded-lg">
                        <button type="button" @click="removePhoto(index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Price -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Цена</label>
            <div class="space-y-2">
                <p class="text-sm text-gray-500">Сумма или по договоренности</p>
                <div class="flex items-center space-x-2">
                    <input
                        x-model="task.price"
                        type="number"
                        min="0"
                        step="0.01"
                        class="input-focus flex-1 px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200"
                        placeholder="0"
                    >
                    <span class="text-gray-600 font-medium">₽</span>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button
            type="submit"
            :disabled="loading || !task.serviceCategory || !task.description || !task.address || !task.date"
            class="btn-gradient w-full py-4 px-6 rounded-xl text-white font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
        >
            <span x-show="!loading">Опубликовать</span>
            <span x-show="loading" class="animate-spin">
                <i class="fas fa-spinner"></i>
            </span>
        </button>
    </form>

    <!-- Back Button -->
    <div class="mt-6 text-center">
        <button @click="goBack()" class="text-gray-500 hover:text-gray-700 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Назад
        </button>
    </div>

    <!-- Success Message -->
    <div x-show="success" x-transition class="mt-6 p-4 bg-green-500/20 border border-green-500/30 rounded-xl animate-slide-up">
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle text-green-400"></i>
            <span class="text-green-300 text-sm" x-text="success"></span>
        </div>
    </div>

    <!-- Error Message -->
    <div x-show="error" x-transition class="mt-6 p-4 bg-red-500/20 border border-red-500/30 rounded-xl animate-slide-up">
        <div class="flex items-center space-x-2">
            <i class="fas fa-exclamation-triangle text-red-400"></i>
            <span class="text-red-300 text-sm" x-text="error"></span>
        </div>
    </div>
</div>

<script>
function createTask() {
    return {
        task: {
            serviceCategory: '',
            description: '',
            address: '',
            date: '',
            price: null,
            photos: []
        },
        loading: false,
        success: '',
        error: '',

        init() {
            this.task.date = new Date().toISOString().split('T')[0];
        },

        handlePhotoUpload(event) {
            const files = event.target.files;
            if (files) {
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.task.photos.push(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        },

        removePhoto(index) {
            this.task.photos.splice(index, 1);
        },

        async createTask() {
            this.loading = true;
            this.error = '';
            this.success = '';

            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    throw new Error('Не авторизован');
                }

                const response = await fetch('/api/v1/tasks/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        service_category: this.task.serviceCategory,
                        description: this.task.description,
                        address: this.task.address,
                        date: this.task.date,
                        price: this.task.price || null,
                        photos: this.task.photos
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.success = 'Задача успешно создана!';
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    const data = await response.json();
                    this.error = data.detail || 'Ошибка создания задачи';
                }
            } catch (error) {
                this.error = 'Ошибка сети. Попробуйте позже.';
            } finally {
                this.loading = false;
            }
        },

        goBack() {
            window.history.back();
        }
    }
}
</script>
{% endblock %}
